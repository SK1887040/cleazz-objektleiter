<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Cleazz Objektleiter v3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'cleazz-blue': {
              50: '#e6f3fa',
              100: '#cce7f5',
              200: '#99cfeb',
              300: '#66b7e1',
              400: '#339fd7',
              500: '#1a7bb9',
              600: '#156294',
              700: '#104a6f',
              800: '#0a314a',
              900: '#051925',
            },
            'cleazz-green': {
              50: '#f2f9e8',
              100: '#e5f3d1',
              200: '#cbe7a3',
              300: '#b1db75',
              400: '#97cf47',
              500: '#7ab51d',
              600: '#629117',
              700: '#496d11',
              800: '#31480c',
              900: '#182406',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-cleazz-blue-50 to-white min-h-screen">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const supabaseUrl = 'https://xuqduttgcnizfxrqymnf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1cWR1dHRnY25pemZ4cnF5bW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNjgwOTksImV4cCI6MjA4NDg0NDA5OX0.p6mVm1hyIbSwpcTTyc63e0pmEfP3Xdw8v2A5JAT7y98';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const GPS_RADIUS = 100; // Meter - f√ºr Objekt Ein-/Ausloggen

    const getAddressFromGPS = async (lat, lng) => {
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`,
          {
            headers: {
              'User-Agent': 'Cleazz-Objektleiter-App'
            }
          }
        );
        const data = await response.json();
        
        if (data && data.address) {
          const addr = data.address;
          const street = addr.road || addr.pedestrian || addr.path || '';
          const houseNumber = addr.house_number || '';
          const postcode = addr.postcode || '';
          const city = addr.city || addr.town || addr.village || '';
          
          // Format: "Stra√üe Hausnummer, PLZ Stadt"
          let fullAddress = '';
          if (street) {
            fullAddress = houseNumber ? `${street} ${houseNumber}` : street;
          }
          if (postcode && city) {
            fullAddress += fullAddress ? `, ${postcode} ${city}` : `${postcode} ${city}`;
          } else if (city) {
            fullAddress += fullAddress ? `, ${city}` : city;
          }
          
          return fullAddress || 'Adresse nicht verf√ºgbar';
        }
        return 'Adresse nicht verf√ºgbar';
      } catch (err) {
        console.error('Geocoding-Fehler:', err);
        return null;
      }
    };

    const formatDistance = (meters) => {
      if (meters < 1000) return `${Math.round(meters)} m`;
      return `${(meters / 1000).toFixed(1)} km`;
    };

    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371e3; // Erdradius in Metern
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    };

    const formatDuration = (seconds) => {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      
      // Format: HH:MM:SS oder MM:SS wenn unter 1 Stunde
      if (h === 0) {
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
      }
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    };

    // Login Component
    function LoginScreen({ onLoginSuccess }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [gpsBlocked, setGpsBlocked] = useState(false);
      const [checkingGps, setCheckingGps] = useState(true);

      // GPS-Check beim Mount
      useEffect(() => {
        checkGPSAvailability();
      }, []);

      const checkGPSAvailability = async () => {
        setCheckingGps(true);
        try {
          // Schneller Check mit 2 Sekunden Timeout
          const position = await new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
              reject(new Error('GPS nicht verf√ºgbar'));
              return;
            }
            
            navigator.geolocation.getCurrentPosition(
              resolve,
              reject,
              {
                enableHighAccuracy: false,  // Schneller - nutzt WiFi/Cellular statt GPS-Satellit
                timeout: 2000,              // Nur 2 Sekunden Timeout
                maximumAge: 60000           // Cache f√ºr 60 Sekunden OK
              }
            );
          });
          
          // GPS funktioniert!
          console.log('‚úÖ GPS verf√ºgbar:', position.coords);
          setGpsBlocked(false);
          
        } catch (error) {
          console.error('‚ùå GPS-Check Fehler:', error);
          
          // GPS blockiert oder Fehler
          if (error.code === 1) {
            // PERMISSION_DENIED - Das ist das wichtige!
            setGpsBlocked(true);
          } else if (error.code === 2) {
            // POSITION_UNAVAILABLE - Ger√§t hat kein GPS, aber Permission OK
            console.log('‚ö†Ô∏è GPS-Signal schwach, aber Permission OK - Login erlauben');
            setGpsBlocked(false);
          } else if (error.code === 3) {
            // TIMEOUT - Zu langsam, aber Permission OK
            console.log('‚ö†Ô∏è GPS-Timeout, aber Permission OK - Login erlauben');
            setGpsBlocked(false);
          } else {
            // Unbekannter Fehler - lieber blockieren
            setGpsBlocked(true);
          }
        } finally {
          setCheckingGps(false);
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const { data: user, error: dbError } = await supabase
            .from('ol_users')
            .select('*')
            .eq('email', email.trim().toLowerCase())
            .single();

          if (dbError || !user) {
            setError('Ung√ºltige E-Mail oder Passwort');
            setLoading(false);
            return;
          }

          if (user.password_hash !== password) {
            setError('Ung√ºltige E-Mail oder Passwort');
            setLoading(false);
            return;
          }

          localStorage.setItem('ol_user', JSON.stringify(user));
          onLoginSuccess(user);
          
        } catch (err) {
          console.error('Login-Fehler:', err);
          setError('Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-5xl font-bold mb-2">
                <span className="text-cleazz-blue-500">cleaz</span>
                <span className="text-cleazz-green-500">z.</span>
              </h1>
              <p className="text-gray-600 text-lg">Objektleiter</p>
              <p className="text-xs text-gray-400 mt-2">Version 3.2</p>
            </div>

            {/* GPS wird gepr√ºft */}
            {checkingGps && (
              <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cleazz-blue-500 mx-auto mb-4"></div>
                <p className="text-gray-600">Pr√ºfe GPS-Zugriff...</p>
              </div>
            )}

            {/* GPS blockiert - Hilfe anzeigen */}
            {!checkingGps && gpsBlocked && (
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">‚ö†Ô∏è</div>
                  <h2 className="text-2xl font-bold text-red-600 mb-2">
                    GPS-Zugriff blockiert
                  </h2>
                  <p className="text-gray-600">
                    Diese App ben√∂tigt GPS-Zugriff f√ºr die Zeiterfassung.
                  </p>
                </div>

                {/* iPhone/Safari Anleitung */}
                <div className="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                  <h3 className="font-bold text-blue-900 mb-2">üì± iPhone (Safari):</h3>
                  <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                    <li>Einstellungen √∂ffnen</li>
                    <li>Nach unten scrollen zu "Safari"</li>
                    <li>"Standort" antippen</li>
                    <li>Auf "Fragen" oder "Erlauben" stellen</li>
                  </ol>
                </div>

                {/* Android/Chrome Anleitung */}
                <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                  <h3 className="font-bold text-green-900 mb-2">ü§ñ Android (Chrome):</h3>
                  <ol className="text-sm text-green-800 space-y-1 list-decimal list-inside">
                    <li>‚ãÆ Men√º (oben rechts) √∂ffnen</li>
                    <li>"Einstellungen" ‚Üí "Website-Einstellungen"</li>
                    <li>"Standort" antippen</li>
                    <li>Auf "Erlauben" stellen</li>
                  </ol>
                </div>

                <button
                  onClick={() => window.location.reload()}
                  className="w-full bg-cleazz-blue-500 hover:bg-cleazz-blue-600 text-white font-semibold py-4 rounded-lg transition flex items-center justify-center gap-2"
                >
                  <span>üîÑ</span>
                  Nach Aktivierung: Seite neu laden
                </button>

                <p className="text-xs text-gray-500 text-center mt-4">
                  Bei Problemen kontaktiere deinen Vorgesetzten.
                </p>
              </div>
            )}

            {/* Normaler Login - nur wenn GPS OK */}
            {!checkingGps && !gpsBlocked && (
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">
                  Anmelden
                </h2>

                {error && (
                  <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    {error}
                  </div>
                )}

              <form onSubmit={handleLogin} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    E-Mail
                  </label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cleazz-blue-500 focus:border-transparent outline-none transition"
                    placeholder="ihre.email@beispiel.de"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Passwort
                  </label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cleazz-blue-500 focus:border-transparent outline-none transition"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                </div>

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-cleazz-blue-500 hover:bg-cleazz-blue-600 text-white font-semibold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Anmelden...' : 'Anmelden'}
                </button>
              </form>

              <p className="mt-6 text-center text-sm text-gray-500">
                Kein Zugang? Wenden Sie sich an Ihren Administrator.
              </p>
            </div>
            )}
          </div>
        </div>
      );
    }

    // Time History Component
    function TimeHistory({ user, onBack }) {
      const [timeEntries, setTimeEntries] = useState([]);
      const [workSessions, setWorkSessions] = useState([]);
      const [pauses, setPauses] = useState([]);
      const [loading, setLoading] = useState(true);
      const [filter, setFilter] = useState('today'); // today, 7days, 30days
      const [currentTime, setCurrentTime] = useState(new Date());

      useEffect(() => {
        loadHistory();
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, [filter]);

      const getDateRange = () => {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        switch(filter) {
          case 'today':
            return { start: today, end: now };
          case '7days':
            const week = new Date(today);
            week.setDate(week.getDate() - 7);
            return { start: week, end: now };
          case '30days':
            const month = new Date(today);
            month.setDate(month.getDate() - 30);
            return { start: month, end: now };
          default:
            return { start: today, end: now };
        }
      };

      const loadHistory = async () => {
        setLoading(true);
        try {
          const { start, end } = getDateRange();

          // Work Sessions laden
          const { data: sessions, error: sessionsError } = await supabase
            .from('ol_work_sessions')
            .select('*')
            .eq('user_id', user.id)
            .gte('start_time', start.toISOString())
            .lte('start_time', end.toISOString())
            .order('start_time', { ascending: false });

          if (sessionsError) throw sessionsError;

          // Time Entries laden (mit Objekt-Infos)
          const { data: entries, error: entriesError } = await supabase
            .from('ol_time_entries')
            .select('*, ol_objects(*)')
            .eq('user_id', user.id)
            .gte('check_in', start.toISOString())
            .lte('check_in', end.toISOString())
            .order('check_in', { ascending: false });

          if (entriesError) throw entriesError;

          // Pausen laden
          const { data: pauses, error: pausesError } = await supabase
            .from('ol_pauses')
            .select('*')
            .eq('user_id', user.id)
            .gte('start_time', start.toISOString())
            .lte('start_time', end.toISOString())
            .order('start_time', { ascending: false });

          if (pausesError) throw pausesError;

          setWorkSessions(sessions || []);
          setTimeEntries(entries || []);
          setPauses(pauses || []);
        } catch (err) {
          console.error('Fehler beim Laden des Verlaufs:', err);
        } finally {
          setLoading(false);
        }
      };

      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) {
          return 'Heute';
        } else if (date.toDateString() === yesterday.toDateString()) {
          return 'Gestern';
        }
        return date.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
      };

      const formatTime = (dateStr) => {
        return new Date(dateStr).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      };

      const calculateDuration = (start, end) => {
        const startDate = new Date(start);
        const endDate = end ? new Date(end) : new Date();
        const seconds = Math.floor((endDate - startDate) / 1000);
        return formatDuration(seconds);
      };

      const groupByDate = (items) => {
        const groups = {};
        items.forEach(item => {
          const date = new Date(item.start_time || item.check_in).toDateString();
          if (!groups[date]) groups[date] = [];
          groups[date].push(item);
        });
        return groups;
      };

      const pauseGroups = groupByDate(pauses);

      const buildTimeline = (date) => {
        const sessions = sessionGroups[date] || [];
        const entries = entryGroups[date] || [];
        const datePauses = pauseGroups[date] || [];
        
        // Alle Events sammeln
        const events = [];
        
        sessions.forEach(session => {
          // Arbeitsbeginn
          events.push({
            type: 'work_start',
            time: session.start_time,
            data: session
          });
          
          // Arbeitsende
          if (session.end_time) {
            events.push({
              type: 'work_end',
              time: session.end_time,
              data: session
            });
          }
        });
        
        // Pausen als separate Events
        datePauses.forEach(pause => {
          events.push({
            type: 'pause',
            time: pause.start_time,
            data: pause
          });
        });
        
        entries.forEach(entry => {
          events.push({
            type: 'object',
            time: entry.check_in,
            data: entry
          });
        });
        
        // Sortieren: √§lteste zuerst (unten), neueste oben
        events.sort((a, b) => new Date(a.time) - new Date(b.time));
        
        return events;
      };

      const renderEvent = (event, index) => {
        switch(event.type) {
          case 'work_start':
            return (
              <div key={`start-${index}`} className="bg-cleazz-blue-50 border border-cleazz-blue-200 rounded-lg p-4">
                <div className="flex items-center gap-2">
                  <svg className="h-5 w-5 text-cleazz-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span className="font-semibold text-gray-900">Arbeitsbeginn</span>
                </div>
                <div className="text-sm text-gray-600 mt-1 ml-7">
                  {formatTime(event.data.start_time)}
                </div>
                {event.data.start_gps_address && (
                  <div className="text-xs text-gray-500 mt-1 ml-7">
                    üìç {event.data.start_gps_address}
                  </div>
                )}
              </div>
            );
            
          case 'work_end':
            return (
              <div key={`end-${index}`} className="bg-gray-100 border border-gray-300 rounded-lg p-4">
                <div className="flex items-center gap-2">
                  <svg className="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                  </svg>
                  <span className="font-semibold text-gray-900">Arbeitsende</span>
                </div>
                <div className="text-sm text-gray-600 mt-1 ml-7">
                  {formatTime(event.data.end_time)}
                </div>
                {event.data.end_gps_address && (
                  <div className="text-xs text-gray-500 mt-1 ml-7">
                    üìç {event.data.end_gps_address}
                  </div>
                )}
              </div>
            );
            
          case 'pause':
            const pause = event.data;
            const pauseDuration = pause.end_time 
              ? calculateDuration(pause.start_time, pause.end_time)
              : null;
            
            return (
              <div key={`pause-${pause.id}`} className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <svg className="h-5 w-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                    </svg>
                    <span className="font-semibold text-gray-900">Pause</span>
                  </div>
                  {pauseDuration ? (
                    <span className="text-sm font-medium text-orange-600">{pauseDuration}</span>
                  ) : (
                    <span className="text-xs font-medium text-orange-600 bg-orange-100 px-2 py-1 rounded">
                      L√§uft
                    </span>
                  )}
                </div>
                <div className="text-sm text-gray-600">
                  {formatTime(pause.start_time)} - {pause.end_time ? formatTime(pause.end_time) : 'L√§uft'}
                </div>
                {pause.start_gps_address && (
                  <div className="text-xs text-gray-500 mt-1">
                    üìç Start: {pause.start_gps_address}
                  </div>
                )}
                {pause.end_gps_address && (
                  <div className="text-xs text-gray-500 mt-1">
                    üìç Ende: {pause.end_gps_address}
                  </div>
                )}
              </div>
            );
            
          case 'object':
            const entry = event.data;
            return (
              <div key={`obj-${entry.id}`} className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <svg className="h-5 w-5 text-cleazz-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <span className="font-semibold text-gray-900">
                      {entry.ol_objects?.name || 'Objekt'}
                    </span>
                  </div>
                  {entry.check_out ? (
                    <span className="text-sm font-medium text-cleazz-green-600">
                      {calculateDuration(entry.check_in, entry.check_out)}
                    </span>
                  ) : (
                    <span className="text-xs font-medium text-cleazz-green-600 bg-cleazz-green-50 px-2 py-1 rounded">
                      L√§uft
                    </span>
                  )}
                </div>
                <div className="text-sm text-gray-600">
                  {formatTime(entry.check_in)} - {entry.check_out ? formatTime(entry.check_out) : 'L√§uft'}
                </div>
                {entry.ol_objects && (
                  <div className="text-xs text-gray-500 mt-1">
                    üìç {entry.ol_objects.street}, {entry.ol_objects.city}
                  </div>
                )}
              </div>
            );
            
          default:
            return null;
        }
      };

      const getTotalStats = () => {
        let totalWork = 0;
        let totalPause = 0;
        let totalObject = 0;

        workSessions.forEach(session => {
          if (session.start_time && session.end_time) {
            const duration = (new Date(session.end_time) - new Date(session.start_time)) / 1000;
            totalWork += duration;
            totalPause += (session.pause_minutes || 0) * 60;
          }
        });

        timeEntries.forEach(entry => {
          if (entry.check_in && entry.check_out) {
            const duration = (new Date(entry.check_out) - new Date(entry.check_in)) / 1000;
            totalObject += duration;
          }
        });

        return {
          work: Math.floor(totalWork),
          pause: Math.floor(totalPause),
          object: Math.floor(totalObject)
        };
      };

      const stats = getTotalStats();
      const sessionGroups = groupByDate(workSessions);
      const entryGroups = groupByDate(timeEntries);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cleazz-blue-500"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen pb-6 bg-gray-50">
          {/* Header */}
          <div className="bg-white shadow-sm sticky top-0 z-10">
            <div className="px-4 py-4">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-3">
                  <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg transition">
                    <svg className="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <h1 className="text-xl font-bold text-gray-900">Verlauf</h1>
                </div>
                
                {/* Filter Dropdown */}
                <select
                  value={filter}
                  onChange={(e) => setFilter(e.target.value)}
                  className="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-cleazz-blue-500 focus:border-transparent outline-none"
                >
                  <option value="today">Heute</option>
                  <option value="7days">7 Tage</option>
                  <option value="30days">30 Tage</option>
                </select>
              </div>
            </div>
          </div>

          {/* Statistik */}
          {(workSessions.length > 0 || timeEntries.length > 0) && (
            <div className="px-4 mt-4">
              <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <h3 className="font-semibold text-gray-900 mb-4">Zusammenfassung</h3>
                <div className="grid grid-cols-2 gap-4 mb-3">
                  <div className="text-center p-3 bg-cleazz-blue-50 rounded-lg">
                    <div className="text-xs text-gray-600 mb-1">Arbeitszeit</div>
                    <div className="text-2xl font-bold text-cleazz-blue-500 font-mono">{formatDuration(stats.work)}</div>
                  </div>
                  <div className="text-center p-3 bg-cleazz-green-50 rounded-lg">
                    <div className="text-xs text-gray-600 mb-1">Objekt-Zeit</div>
                    <div className="text-2xl font-bold text-cleazz-green-500 font-mono">{formatDuration(stats.object)}</div>
                  </div>
                </div>
                {stats.pause > 0 && (
                  <div className="text-center pt-2 border-t border-gray-100">
                    <span className="text-sm text-gray-600">Pausen: </span>
                    <span className="text-sm font-medium text-orange-600">{formatDuration(stats.pause)}</span>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Zeiteintr√§ge nach Datum gruppiert */}
          <div className="px-4 mt-4 space-y-4">
            {Object.keys(sessionGroups).length === 0 && Object.keys(entryGroups).length === 0 ? (
              <div className="text-center py-12">
                <svg className="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p className="text-gray-500">Keine Eintr√§ge im ausgew√§hlten Zeitraum</p>
              </div>
            ) : (
              Object.keys(sessionGroups).map(dateKey => {
                const timeline = buildTimeline(dateKey);
                
                return (
                  <div key={dateKey}>
                    {/* Datums-Header */}
                    <div className="text-sm font-semibold text-gray-700 mb-2">
                      {formatDate(dateKey)}, {new Date(dateKey).toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' })}
                    </div>

                    {/* Timeline Events (von neu nach alt = von oben nach unten) */}
                    <div className="space-y-3">
                      {timeline.reverse().map((event, index) => renderEvent(event, index))}
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      );
    }

    // Object Detail Component
    function ObjectDetail({ object, user, workSession: initialWorkSession, userPosition: initialUserPosition, onBack }) {
      const [objectEntry, setObjectEntry] = useState(null);
      const [workSession, setWorkSession] = useState(initialWorkSession);
      const [loading, setLoading] = useState(true);
      const [userPosition, setUserPosition] = useState(initialUserPosition);
      const [currentTime, setCurrentTime] = useState(new Date());
      const [error, setError] = useState('');

      useEffect(() => {
        checkActiveObjectEntry();
        checkActiveWorkSession();
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

      // GPS-Position von parent √ºbernehmen
      useEffect(() => {
        if (initialUserPosition) {
          setUserPosition(initialUserPosition);
        }
      }, [initialUserPosition]);

      const checkActiveWorkSession = async () => {
        try {
          const { data, error } = await supabase
            .from('ol_work_sessions')
            .select('*')
            .eq('user_id', user.id)
            .is('end_time', null)
            .order('start_time', { ascending: false })
            .limit(1);

          if (error) throw error;
          if (data && data.length > 0) {
            setWorkSession(data[0]);
          } else {
            setWorkSession(null);
          }
        } catch (err) {
          console.error('Fehler beim Laden der Arbeitszeit:', err);
        }
      };

      const getCurrentPosition = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setUserPosition({
                lat: position.coords.latitude,
                lng: position.coords.longitude
              });
            },
            (error) => {
              console.error('GPS-Fehler:', error);
            }
          );
        }
      };

      const checkActiveObjectEntry = async () => {
        try {
          const { data, error } = await supabase
            .from('ol_time_entries')
            .select('*')
            .eq('user_id', user.id)
            .eq('object_id', object.id)
            .is('check_out', null)
            .order('check_in', { ascending: false })
            .limit(1);

          if (error) throw error;
          if (data && data.length > 0) {
            setObjectEntry(data[0]);
          }
        } catch (err) {
          console.error('Fehler beim Laden der Objekt-Zeit:', err);
        } finally {
          setLoading(false);
        }
      };

      const startObjectTracking = async () => {
        // Pr√ºfung 1: Arbeitszeit l√§uft?
        if (!workSession) {
          setError('Bitte starten Sie zuerst Ihre Arbeitszeit!');
          return;
        }

        // Pr√ºfung 2: Pause?
        if (workSession.pause_start) {
          setError('Sie k√∂nnen w√§hrend der Pause keine Objekte erfassen. Bitte beenden Sie die Pause.');
          return;
        }

        // Pr√ºfung 3: GPS verf√ºgbar?
        if (!userPosition) {
          setError('GPS-Position wird ermittelt... Bitte warten Sie einen Moment und versuchen Sie es erneut.');
          return;
        }

        // Pr√ºfung 4: Entfernung ‚â§ 100m?
        const distance = calculateDistance(
          userPosition.lat,
          userPosition.lng,
          object.lat,
          object.lng
        );

        if (distance > GPS_RADIUS) {
          setError(`Sie sind zu weit entfernt (${Math.round(distance)}m). Maximal ${GPS_RADIUS}m erlaubt.`);
          return;
        }

        setLoading(true);
        setError('');
        try {
          const { data, error } = await supabase
            .from('ol_time_entries')
            .insert([{
              user_id: user.id,
              object_id: object.id,
              work_session_id: workSession.id,
              entry_type: 'object',
              check_in: new Date().toISOString(),
              gps_check_in_lat: userPosition.lat,
              gps_check_in_lng: userPosition.lng
            }])
            .select()
            .single();

          if (error) throw error;
          setObjectEntry(data);
        } catch (err) {
          console.error('Fehler beim Starten:', err);
          console.error('Fehler Details:', err.message, err.details, err.hint);
          setError(`Fehler: ${err.message || 'Unbekannter Fehler beim Starten der Objekt-Erfassung'}`);
        } finally {
          setLoading(false);
        }
      };

      const endObjectTracking = async () => {
        if (!objectEntry) return;

        // Pr√ºfung 1: GPS verf√ºgbar?
        if (!userPosition) {
          setError('GPS-Position nicht verf√ºgbar. Bitte warten Sie einen Moment und versuchen Sie es erneut.');
          return;
        }

        // Pr√ºfung 2: Entfernung ‚â§ 100m?
        const distance = calculateDistance(
          userPosition.lat,
          userPosition.lng,
          object.lat,
          object.lng
        );

        if (distance > GPS_RADIUS) {
          setError(`Sie sind zu weit entfernt (${Math.round(distance)}m). Maximal ${GPS_RADIUS}m erlaubt.`);
          return;
        }

        if (!confirm('Objekt-Erfassung wirklich beenden?')) {
          return;
        }

        setLoading(true);
        setError('');
        try {
          const { data, error } = await supabase
            .from('ol_time_entries')
            .update({
              check_out: new Date().toISOString(),
              gps_check_out_lat: userPosition.lat,
              gps_check_out_lng: userPosition.lng
            })
            .eq('id', objectEntry.id)
            .select()
            .single();

          if (error) throw error;
          setObjectEntry(null);
          
          // Kurz warten, dann zur√ºck zur Liste
          setTimeout(() => onBack(), 500);
        } catch (err) {
          console.error('Fehler beim Beenden:', err);
          setError('Fehler beim Beenden der Objekt-Erfassung');
        } finally {
          setLoading(false);
        }
      };

      const getObjectDuration = () => {
        if (!objectEntry) return 0;
        const start = new Date(objectEntry.check_in);
        const end = new Date();
        return Math.floor((end - start) / 1000);
      };

      const distance = object.lat && object.lng && userPosition
        ? calculateDistance(userPosition.lat, userPosition.lng, object.lat, object.lng)
        : null;

      const isInRange = distance !== null && distance <= GPS_RADIUS;

      return (
        <div className="min-h-screen pb-6">
          {/* Header */}
          <div className="bg-white shadow-sm sticky top-0 z-10">
            <div className="px-4 py-4">
              <div className="flex items-center gap-3">
                <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg transition">
                  <svg className="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <div className="flex-1">
                  <h1 className="text-xl font-bold text-gray-900">Objektdetails</h1>
                </div>
              </div>
            </div>
          </div>

          <div className="px-4 mt-4 space-y-4">
            {error && (
              <div className="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                {error}
              </div>
            )}

            {/* Objekt-Tracking Buttons */}
            {objectEntry ? (
              <div className="space-y-3">
                {/* Laufende Zeit (gr√ºn, nicht klickbar) */}
                <div className="w-full bg-cleazz-green-500 text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2">
                  <svg className="h-5 w-5 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" />
                  </svg>
                  <span className="font-mono text-lg">{formatDuration(getObjectDuration())}</span>
                </div>

                {/* Objektzeit beenden Button (rot) */}
                <button
                  onClick={endObjectTracking}
                  disabled={loading || !isInRange}
                  className="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                  </svg>
                  Objektzeit beenden
                  {!isInRange && distance && (
                    <span className="text-xs opacity-75">({Math.round(distance)}m entfernt)</span>
                  )}
                </button>
              </div>
            ) : (
              /* Objektzeit starten Button (gr√ºn) */
              <button
                onClick={startObjectTracking}
                disabled={loading || !workSession || workSession.pause_start}
                className="w-full bg-cleazz-green-500 hover:bg-cleazz-green-600 text-white font-medium py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Objektzeit starten
              </button>
            )}

            {/* GPS-Status Info */}
            {distance !== null && (
              <div className={`p-3 rounded-lg text-sm ${isInRange ? 'bg-green-50 text-green-700' : 'bg-orange-50 text-orange-700'}`}>
                <div className="flex items-center gap-2">
                  <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span>
                    {isInRange 
                      ? `Sie sind am Objekt (${Math.round(distance)}m)`
                      : `Sie sind ${Math.round(distance)}m entfernt (max. ${GPS_RADIUS}m)`
                    }
                  </span>
                </div>
              </div>
            )}

            {/* Objekt-Infos */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <div className="flex items-center gap-2 mb-2">
                <span className="text-xs font-medium text-cleazz-blue-600 bg-cleazz-blue-50 px-2 py-1 rounded">
                  {object.customer_number}
                </span>
                {distance && (
                  <span className="text-xs text-gray-500">{formatDistance(distance)}</span>
                )}
              </div>
              <h2 className="text-2xl font-bold text-gray-900 mb-3">{object.name}</h2>
              <div className="space-y-1 text-gray-600">
                <p className="flex items-center gap-2">
                  <svg className="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {object.street}
                </p>
                <p className="pl-6">{object.postal_code} {object.city}</p>
              </div>
            </div>

            {/* Auftragsdetails */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <h3 className="font-semibold text-gray-900 mb-3">Auftragsdetails</h3>
              <div className="space-y-3">
                <div className="flex justify-between py-2 border-b border-gray-100">
                  <span className="text-gray-600">Auftragsart</span>
                  <span className="font-medium text-gray-900">{object.contract_type || '-'}</span>
                </div>
                <div className="flex justify-between py-2 border-b border-gray-100">
                  <span className="text-gray-600">Turnus</span>
                  <span className="font-medium text-gray-900">{object.frequency || '-'}</span>
                </div>
                <div className="flex justify-between py-2 border-b border-gray-100">
                  <span className="text-gray-600">Fl√§che</span>
                  <span className="font-medium text-gray-900">{object.area ? `${object.area} m¬≤` : '-'}</span>
                </div>
                <div className="flex justify-between py-2 border-b border-gray-100">
                  <span className="text-gray-600">Reinigungszeiten</span>
                  <span className="font-medium text-gray-900">{object.schedule || '-'}</span>
                </div>
                <div className="flex justify-between py-2 border-b border-gray-100">
                  <span className="text-gray-600">Schl√ºssel</span>
                  <span className="font-medium text-gray-900">{object.has_key || '-'}</span>
                </div>
              </div>
            </div>

            {/* Subunternehmer */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <h3 className="font-semibold text-gray-900 mb-3">Subunternehmer</h3>
              <div className="space-y-2">
                <div className="flex justify-between py-1">
                  <span className="text-gray-600">Name</span>
                  <span className="font-medium text-gray-900">{object.subcontractor || '-'}</span>
                </div>
                <div className="flex justify-between py-1">
                  <span className="text-gray-600">Lieferanten-Nr.</span>
                  <span className="font-medium text-gray-900">{object.supplier_number || '-'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Object List Component
    function ObjectList({ user, workSession, userPosition: initialUserPosition, onSelectObject, onBack, onShowHistory }) {
      const [objects, setObjects] = useState([]);
      const [filteredObjects, setFilteredObjects] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [loading, setLoading] = useState(true);
      const [userPosition, setUserPosition] = useState(initialUserPosition);
      const [currentTime, setCurrentTime] = useState(new Date());
      const [activeObjectEntry, setActiveObjectEntry] = useState(null);

      useEffect(() => {
        loadObjects();
        checkActiveObjectEntry();
        
        // Timer f√ºr Live-Zeitanzeige
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        
        return () => {
          clearInterval(timer);
        };
      }, []);

      // GPS-Position von parent √ºbernehmen
      useEffect(() => {
        if (initialUserPosition) {
          setUserPosition(initialUserPosition);
        }
      }, [initialUserPosition]);

      const checkActiveObjectEntry = async () => {
        try {
          const { data, error } = await supabase
            .from('ol_time_entries')
            .select('*')
            .eq('user_id', user.id)
            .is('check_out', null)
            .order('check_in', { ascending: false })
            .limit(1);

          if (error) throw error;
          if (data && data.length > 0) {
            setActiveObjectEntry(data[0]);
          }
        } catch (err) {
          console.error('Fehler beim Laden der aktiven Objekt-Zeit:', err);
        }
      };

      useEffect(() => {
        filterAndSortObjects();
      }, [objects, searchTerm, userPosition]);

      const getCurrentPosition = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setUserPosition({
                lat: position.coords.latitude,
                lng: position.coords.longitude
              });
            },
            (error) => {
              console.error('GPS-Fehler:', error);
            }
          );
        }
      };

      const loadObjects = async () => {
        try {
          const { data, error } = await supabase
            .from('ol_objects')
            .select('*')
            .order('name');

          if (error) throw error;
          setObjects(data || []);
        } catch (err) {
          console.error('Fehler beim Laden der Objekte:', err);
        } finally {
          setLoading(false);
        }
      };

      const filterAndSortObjects = () => {
        let filtered = objects;

        // Suche
        if (searchTerm.trim()) {
          const term = searchTerm.toLowerCase();
          filtered = objects.filter(obj =>
            obj.name?.toLowerCase().includes(term) ||
            obj.customer_number?.toLowerCase().includes(term) ||
            obj.street?.toLowerCase().includes(term) ||
            obj.city?.toLowerCase().includes(term)
          );
        }

        // GPS-Entfernung berechnen und sortieren
        if (userPosition) {
          filtered = filtered.map(obj => ({
            ...obj,
            distance: obj.lat && obj.lng 
              ? calculateDistance(userPosition.lat, userPosition.lng, obj.lat, obj.lng)
              : Infinity
          })).sort((a, b) => a.distance - b.distance);
        }

        setFilteredObjects(filtered);
      };

      const getWorkDuration = () => {
        if (!workSession) return 0;
        const start = new Date(workSession.start_time);
        const end = new Date();
        const totalSeconds = Math.floor((end - start) / 1000);
        
        let pauseSeconds = (workSession.pause_minutes || 0) * 60;
        if (workSession.pause_start) {
          const currentPause = Math.floor((new Date() - new Date(workSession.pause_start)) / 1000);
          pauseSeconds += currentPause;
        }
        
        return Math.max(0, totalSeconds - pauseSeconds);
      };

      const isPaused = workSession && workSession.pause_start;

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cleazz-blue-500"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen pb-6">
          {/* Header mit Zeitanzeige */}
          <div className="bg-white shadow-sm sticky top-0 z-10">
            <div className="px-4 py-4">
              <div className="flex items-center justify-between mb-3">
                <button 
                  onClick={onBack}
                  className="p-2 hover:bg-gray-100 rounded-lg transition"
                >
                  <svg className="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                
                <h1 className="text-xl font-bold text-gray-900 flex-1 text-center">Meine Objekte</h1>
                
                <div className="flex items-center gap-2">
                  {/* Verlauf Button */}
                  <button
                    onClick={onShowHistory}
                    className="p-2 hover:bg-gray-100 rounded-lg transition"
                    title="Verlauf anzeigen"
                  >
                    <svg className="h-6 w-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </button>

                  {/* Laufende Zeit oben rechts */}
                  {workSession && !isPaused && (
                    <div className="px-3 py-2 text-sm bg-cleazz-green-50 text-cleazz-green-700 border border-cleazz-green-200 rounded-lg flex items-center gap-2">
                      <svg className="h-4 w-4 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                      </svg>
                      <span className="font-medium font-mono">{formatDuration(getWorkDuration())}</span>
                    </div>
                  )}
                  
                  {isPaused && (
                    <div className="px-3 py-2 text-sm bg-orange-50 text-orange-700 border border-orange-200 rounded-lg">
                      <span className="font-medium">Pause</span>
                    </div>
                  )}
                </div>
              </div>

              {/* Suchfeld */}
              <div className="relative">
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  placeholder="Suche nach Name, Kundennr., Stra√üe..."
                  className="w-full px-4 py-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cleazz-blue-500 focus:border-transparent outline-none"
                />
                <svg className="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>
          </div>

          {/* Objektliste */}
          <div className="px-4 mt-4 space-y-3">
            {filteredObjects.length === 0 ? (
              <div className="text-center py-12">
                <svg className="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <p className="text-gray-500">
                  {searchTerm ? 'Keine Objekte gefunden' : 'Keine Objekte vorhanden'}
                </p>
              </div>
            ) : (
              filteredObjects.map((obj) => (
                <div
                  key={obj.id}
                  className="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition cursor-pointer"
                  onClick={() => onSelectObject(obj)}
                >
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1 flex-wrap">
                        <span className="text-xs font-medium text-cleazz-blue-600 bg-cleazz-blue-50 px-2 py-1 rounded">
                          {obj.customer_number}
                        </span>
                        {obj.distance !== Infinity && (
                          <span className="text-xs text-gray-500">
                            {formatDistance(obj.distance)}
                          </span>
                        )}
                        {activeObjectEntry && activeObjectEntry.object_id === obj.id && (
                          <span className="text-xs font-medium text-cleazz-green-600 bg-cleazz-green-50 px-2 py-1 rounded flex items-center gap-1">
                            <svg className="h-3 w-3 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                              <circle cx="12" cy="12" r="10" />
                            </svg>
                            Im Objekt
                          </span>
                        )}
                      </div>
                      <h3 className="font-semibold text-gray-900 text-lg">{obj.name}</h3>
                    </div>
                  </div>

                  <div className="space-y-1 text-sm text-gray-600">
                    <p>{obj.street}</p>
                    <p>{obj.postal_code} {obj.city}</p>
                  </div>

                  {obj.contract_type && (
                    <div className="mt-2 pt-2 border-t border-gray-100">
                      <span className="text-xs text-gray-500">{obj.contract_type}</span>
                    </div>
                  )}
                </div>
              ))
            )}
          </div>

          {/* Footer Info */}
          {filteredObjects.length > 0 && (
            <div className="px-4 mt-6 text-center text-sm text-gray-500">
              {filteredObjects.length} Objekt{filteredObjects.length !== 1 ? 'e' : ''}
              {userPosition && ' ‚Ä¢ Sortiert nach Entfernung'}
            </div>
          )}
        </div>
      );
    }

    // Main Work Time Tracking Component
    function WorkTimeTracking({ user, onLogout, onShowObjects }) {
      const [workSession, setWorkSession] = useState(null);
      const [loading, setLoading] = useState(true);
      const [currentTime, setCurrentTime] = useState(new Date());
      const [error, setError] = useState('');

      useEffect(() => {
        checkActiveWorkSession();
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

      const checkActiveWorkSession = async () => {
        try {
          const { data, error } = await supabase
            .from('ol_work_sessions')
            .select('*')
            .eq('user_id', user.id)
            .is('end_time', null)
            .order('start_time', { ascending: false })
            .limit(1);

          if (error) throw error;
          if (data && data.length > 0) {
            setWorkSession(data[0]);
          }
        } catch (err) {
          console.error('Fehler beim Laden der Arbeitszeit:', err);
          setError('Fehler beim Laden der Arbeitszeit');
        } finally {
          setLoading(false);
        }
      };

      const startWorkSession = async () => {
        setLoading(true);
        setError('');
        try {
          // GPS holen
          let gpsLat = null;
          let gpsLng = null;
          let gpsAddress = null;

          if (navigator.geolocation) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                });
              });
              
              gpsLat = position.coords.latitude;
              gpsLng = position.coords.longitude;
              
              // Adresse holen
              gpsAddress = await getAddressFromGPS(gpsLat, gpsLng);
            } catch (gpsErr) {
              console.error('GPS-Fehler beim Start:', gpsErr);
            }
          }

          const { data, error } = await supabase
            .from('ol_work_sessions')
            .insert([{
              user_id: user.id,
              start_time: new Date().toISOString(),
              pause_minutes: 0,
              start_gps_lat: gpsLat,
              start_gps_lng: gpsLng,
              start_gps_address: gpsAddress
            }])
            .select()
            .single();

          if (error) throw error;
          setWorkSession(data);
        } catch (err) {
          console.error('Fehler beim Starten:', err);
          setError('Fehler beim Starten der Arbeitszeit');
        } finally {
          setLoading(false);
        }
      };

      const startPause = async () => {
        if (!workSession) return;
        setLoading(true);
        setError('');
        try {
          // GPS holen
          let gpsLat = null;
          let gpsLng = null;
          let gpsAddress = null;

          if (navigator.geolocation) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                });
              });
              
              gpsLat = position.coords.latitude;
              gpsLng = position.coords.longitude;
              gpsAddress = await getAddressFromGPS(gpsLat, gpsLng);
            } catch (gpsErr) {
              console.error('GPS-Fehler bei Pause Start:', gpsErr);
            }
          }

          // Neue Pause in ol_pauses erstellen
          const { data: pauseData, error: pauseError } = await supabase
            .from('ol_pauses')
            .insert([{
              user_id: user.id,
              work_session_id: workSession.id,
              start_time: new Date().toISOString(),
              start_gps_lat: gpsLat,
              start_gps_lng: gpsLng,
              start_gps_address: gpsAddress
            }])
            .select()
            .single();

          if (pauseError) throw pauseError;

          // Work session aktualisieren (pause_start f√ºr UI-State)
          const { data, error } = await supabase
            .from('ol_work_sessions')
            .update({ pause_start: new Date().toISOString() })
            .eq('id', workSession.id)
            .select()
            .single();

          if (error) throw error;
          setWorkSession(data);
        } catch (err) {
          console.error('Fehler beim Starten der Pause:', err);
          setError('Fehler beim Starten der Pause');
        } finally {
          setLoading(false);
        }
      };

      const endPause = async () => {
        if (!workSession || !workSession.pause_start) return;
        setLoading(true);
        setError('');
        try {
          // GPS holen
          let gpsLat = null;
          let gpsLng = null;
          let gpsAddress = null;

          if (navigator.geolocation) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                });
              });
              
              gpsLat = position.coords.latitude;
              gpsLng = position.coords.longitude;
              gpsAddress = await getAddressFromGPS(gpsLat, gpsLng);
            } catch (gpsErr) {
              console.error('GPS-Fehler bei Pause Ende:', gpsErr);
            }
          }

          // Letzte offene Pause finden und beenden
          const { data: openPauses, error: findError } = await supabase
            .from('ol_pauses')
            .select('*')
            .eq('work_session_id', workSession.id)
            .is('end_time', null)
            .order('start_time', { ascending: false })
            .limit(1);

          if (findError) throw findError;

          if (openPauses && openPauses.length > 0) {
            const pause = openPauses[0];
            
            // Pause beenden
            const { error: updateError } = await supabase
              .from('ol_pauses')
              .update({
                end_time: new Date().toISOString(),
                end_gps_lat: gpsLat,
                end_gps_lng: gpsLng,
                end_gps_address: gpsAddress
              })
              .eq('id', pause.id);

            if (updateError) throw updateError;
          }

          // Pause-Minuten berechnen und work_session aktualisieren
          const pauseStart = new Date(workSession.pause_start);
          const pauseEnd = new Date();
          const pauseDuration = Math.floor((pauseEnd - pauseStart) / 60000);
          const totalPauseMinutes = (workSession.pause_minutes || 0) + pauseDuration;

          const { data, error } = await supabase
            .from('ol_work_sessions')
            .update({ 
              pause_start: null,
              pause_minutes: totalPauseMinutes
            })
            .eq('id', workSession.id)
            .select()
            .single();

          if (error) throw error;
          setWorkSession(data);
        } catch (err) {
          console.error('Fehler beim Beenden der Pause:', err);
          setError('Fehler beim Beenden der Pause');
        } finally {
          setLoading(false);
        }
      };

      const endWorkSession = async () => {
        if (!workSession) return;
        
        // Wenn Pause l√§uft, erst Pause beenden
        if (workSession.pause_start) {
          if (!confirm('Pause l√§uft noch. Soll die Pause beendet und die Arbeitszeit gestoppt werden?')) {
            return;
          }
          await endPause();
        }

        // Pr√ºfen ob noch Objekt-Zeit l√§uft
        try {
          const { data: openEntries, error: checkError } = await supabase
            .from('ol_time_entries')
            .select('*')
            .eq('user_id', user.id)
            .is('check_out', null);

          if (checkError) throw checkError;

          // Wenn offene Objekt-Zeiten existieren
          if (openEntries && openEntries.length > 0) {
            if (!confirm(`Sie haben noch ${openEntries.length} offene Objekt-Erfassung(en). Diese werden automatisch beendet. Fortfahren?`)) {
              return;
            }

            // Alle offenen Objekt-Zeiten beenden
            for (const entry of openEntries) {
              await supabase
                .from('ol_time_entries')
                .update({
                  check_out: new Date().toISOString(),
                  gps_check_out_lat: null, // Kein GPS beim automatischen Beenden
                  gps_check_out_lng: null
                })
                .eq('id', entry.id);
            }
          }
        } catch (err) {
          console.error('Fehler beim Pr√ºfen offener Objekt-Zeiten:', err);
        }

        if (!confirm('Arbeitszeit wirklich beenden?')) {
          return;
        }

        setLoading(true);
        setError('');
        try {
          // GPS holen
          let gpsLat = null;
          let gpsLng = null;
          let gpsAddress = null;

          if (navigator.geolocation) {
            try {
              const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                });
              });
              
              gpsLat = position.coords.latitude;
              gpsLng = position.coords.longitude;
              gpsAddress = await getAddressFromGPS(gpsLat, gpsLng);
            } catch (gpsErr) {
              console.error('GPS-Fehler bei Arbeitsende:', gpsErr);
            }
          }

          const { data, error } = await supabase
            .from('ol_work_sessions')
            .update({ 
              end_time: new Date().toISOString(),
              end_gps_lat: gpsLat,
              end_gps_lng: gpsLng,
              end_gps_address: gpsAddress
            })
            .eq('id', workSession.id)
            .select()
            .single();

          if (error) throw error;
          setWorkSession(null);
        } catch (err) {
          console.error('Fehler beim Beenden:', err);
          setError('Fehler beim Beenden der Arbeitszeit');
        } finally {
          setLoading(false);
        }
      };

      const getWorkDuration = () => {
        if (!workSession) return 0;
        const start = new Date(workSession.start_time);
        const end = new Date();
        const totalSeconds = Math.floor((end - start) / 1000);
        
        let pauseSeconds = (workSession.pause_minutes || 0) * 60;
        if (workSession.pause_start) {
          const currentPause = Math.floor((new Date() - new Date(workSession.pause_start)) / 1000);
          pauseSeconds += currentPause;
        }
        
        return Math.max(0, totalSeconds - pauseSeconds);
      };

      const getCurrentPauseDuration = () => {
        if (!workSession || !workSession.pause_start) return 0;
        return Math.floor((new Date() - new Date(workSession.pause_start)) / 1000);
      };

      const isPaused = workSession && workSession.pause_start;

      if (loading && !workSession) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cleazz-blue-500"></div>
          </div>
        );
      }

      return (
        <div className="min-h-screen p-4">
          <div className="max-w-md mx-auto">
            {/* Header */}
            <div className="text-center mb-8 pt-6">
              <h1 className="text-4xl font-bold mb-1">
                <span className="text-cleazz-blue-500">cleaz</span>
                <span className="text-cleazz-green-500">z.</span>
              </h1>
              <p className="text-gray-600">Hallo, {user.name || user.email}</p>
            </div>

            {error && (
              <div className="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                {error}
              </div>
            )}

            {/* Keine Arbeitszeit aktiv */}
            {!workSession && (
              <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                <div className="mb-6">
                  <svg className="h-20 w-20 text-cleazz-blue-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">Arbeitszeit starten</h2>
                  <p className="text-gray-600">Starten Sie Ihre Arbeitszeit f√ºr heute</p>
                </div>
                <button
                  onClick={startWorkSession}
                  disabled={loading}
                  className="w-full bg-cleazz-green-500 hover:bg-cleazz-green-600 text-white font-semibold py-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed text-lg"
                >
                  {loading ? 'Starte...' : 'Arbeitszeit starten'}
                </button>
                <button
                  onClick={onLogout}
                  className="w-full mt-4 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                >
                  Abmelden
                </button>
              </div>
            )}

            {/* Arbeitszeit l√§uft */}
            {workSession && !isPaused && (
              <div className="space-y-4">
                <div className="bg-white rounded-2xl shadow-xl p-8">
                  <div className="text-center mb-6">
                    <p className="text-sm text-gray-600 mb-2">Arbeitszeit</p>
                    <div className="text-5xl font-bold text-cleazz-blue-500 mb-4 font-mono">
                      {formatDuration(getWorkDuration())}
                    </div>
                    <div className="flex items-center justify-center gap-2 text-sm text-gray-500">
                      <svg className="h-4 w-4 animate-pulse text-cleazz-green-500" fill="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                      </svg>
                      Zeit l√§uft
                    </div>
                  </div>

                  <div className="space-y-3">
                    <button
                      onClick={onShowObjects}
                      className="w-full bg-cleazz-blue-500 hover:bg-cleazz-blue-600 text-white font-semibold py-3 rounded-lg transition flex items-center justify-center gap-2"
                    >
                      <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                      </svg>
                      Zu meinen Objekten
                    </button>

                    <button
                      onClick={startPause}
                      disabled={loading}
                      className="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                      </svg>
                      Pause starten
                    </button>

                    <button
                      onClick={endWorkSession}
                      disabled={loading}
                      className="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                    >
                      <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                      </svg>
                      Arbeitszeit beenden
                    </button>
                  </div>
                </div>

                {workSession.pause_minutes > 0 && (
                  <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                    <p className="text-sm text-orange-700">
                      Bisherige Pausen: {Math.floor(workSession.pause_minutes / 60)}h {workSession.pause_minutes % 60}min
                    </p>
                  </div>
                )}
              </div>
            )}

            {/* Pause l√§uft */}
            {workSession && isPaused && (
              <div className="space-y-4">
                <div className="bg-orange-500 text-white rounded-2xl shadow-xl p-8">
                  <div className="text-center mb-6">
                    <div className="flex items-center justify-center gap-2 mb-4">
                      <svg className="h-8 w-8" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z" />
                      </svg>
                      <p className="text-xl font-bold">PAUSE</p>
                    </div>
                    <div className="text-5xl font-bold mb-4 font-mono">
                      {formatDuration(getCurrentPauseDuration())}
                    </div>
                    <p className="text-orange-100 text-sm">
                      Arbeitszeit gesamt: {formatDuration(getWorkDuration())}
                    </p>
                  </div>

                  <button
                    onClick={endPause}
                    disabled={loading}
                    className="w-full bg-white hover:bg-gray-100 text-orange-600 font-semibold py-3 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    <svg className="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z" />
                    </svg>
                    Pause beenden
                  </button>
                </div>

                <div className="bg-white rounded-lg p-4 text-center">
                  <p className="text-sm text-gray-600">
                    W√§hrend der Pause k√∂nnen Sie keine Objekte erfassen
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Main App
    function App() {
      const [user, setUser] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [showObjects, setShowObjects] = useState(false);
      const [showHistory, setShowHistory] = useState(false);
      const [selectedObject, setSelectedObject] = useState(null);
      const [workSession, setWorkSession] = useState(null);
      const [userPosition, setUserPosition] = useState(null);

      useEffect(() => {
        const savedUser = localStorage.getItem('ol_user');
        if (savedUser) {
          try {
            const parsedUser = JSON.parse(savedUser);
            setUser(parsedUser);
            checkActiveWorkSession(parsedUser);
          } catch (e) {
            localStorage.removeItem('ol_user');
          }
        }
        setIsLoading(false);

        // GPS initialisieren
        initGPS();

        // GPS alle 5 Minuten aktualisieren
        const gpsInterval = setInterval(initGPS, 5 * 60 * 1000);
        return () => clearInterval(gpsInterval);
      }, []);

      const initGPS = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setUserPosition({
                lat: position.coords.latitude,
                lng: position.coords.longitude
              });
              console.log('GPS aktualisiert:', position.coords.latitude, position.coords.longitude);
            },
            (error) => {
              console.error('GPS-Fehler:', error);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 30000 // Cache GPS f√ºr 30 Sekunden
            }
          );
        }
      };

      const checkActiveWorkSession = async (currentUser) => {
        try {
          const { data, error } = await supabase
            .from('ol_work_sessions')
            .select('*')
            .eq('user_id', currentUser.id)
            .is('end_time', null)
            .order('start_time', { ascending: false })
            .limit(1);

          if (error) throw error;
          if (data && data.length > 0) {
            setWorkSession(data[0]);
          }
        } catch (err) {
          console.error('Fehler beim Laden der Arbeitszeit:', err);
        }
      };

      const handleLogout = () => {
        localStorage.removeItem('ol_user');
        setUser(null);
        setWorkSession(null);
        setShowObjects(false);
      };

      if (isLoading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-cleazz-blue-500"></div>
          </div>
        );
      }

      if (!user) {
        return <LoginScreen onLoginSuccess={(u) => { setUser(u); checkActiveWorkSession(u); }} />;
      }

      // Verlaufs-Ansicht anzeigen
      if (showHistory) {
        return (
          <TimeHistory
            user={user}
            onBack={() => setShowHistory(false)}
          />
        );
      }

      // Objekt-Detail anzeigen
      if (selectedObject) {
        return (
          <ObjectDetail
            object={selectedObject}
            user={user}
            workSession={workSession}
            userPosition={userPosition}
            onBack={() => {
              setSelectedObject(null);
              checkActiveWorkSession(user);
            }}
          />
        );
      }

      // Objektliste anzeigen
      if (showObjects) {
        return (
          <ObjectList 
            user={user}
            workSession={workSession}
            userPosition={userPosition}
            onSelectObject={setSelectedObject}
            onBack={() => setShowObjects(false)}
            onShowHistory={() => setShowHistory(true)}
          />
        );
      }

      // Haupt-Zeiterfassung
      return (
        <WorkTimeTracking 
          user={user} 
          onLogout={handleLogout}
          onShowObjects={() => setShowObjects(true)}
        />
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
